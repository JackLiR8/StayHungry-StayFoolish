http2 notes

## 特点 
1. 标头字段压缩
2. 同一链接上进行多个并发交换
3. 为请求设置优先级
4. 二进制分帧对消息进行更高效处理

## 二进制分帧层
>“层”指的是新的编码机制，位于套接字接口与应用可见的高级 HTTP API 之间

## 数据流、消息、帧
>**数据流**： 已建立链接内部的双向字节流，可承载一条或多条消息  
**消息**： 与逻辑请求或响应消息对应的完整的一系列帧  
**帧**： HTTP/2 通信的最小单位，都包含帧头，都标识当前帧所属的数据流  

+ 所有通信都在一个TCP连接上完成，此连接可以可以承载任意数量的双向数据流
+ 每个数据流都有一个唯一标识符和可选的优先级信息，用于承载双向消息
+ 每条消息都是一条逻辑 HTTP 消息（例如请求或响应），包含一个或多个帧
+ 帧是最小的通信单位，承载着特定类型的数据，例如 HTTP 标头、消息负载等等。 *来自不同数据流的帧可以交错发送，然后再根据每个帧头的数据流标识符重新组装*

## 请求和响应复用
将 HTTP 消息分解为独立的帧，交错发送，然后在另一端重新组装是 HTTP 2 最重要的一项增强。  
性能提升：  
+ 并行交错地发送多个请求，请求之间互不影响
+ 并行交错地发送多个响应，响应之间互不影响
+ 使用一个连接并行发送多个请求和响应
+ 消除不必要的延迟和提高现有网络容量的利用率，从而减少页面加载时间
+ 不必再为绕过 HTTP/1.x 限制而做很多工作

## 数据流优先级
客户端和服务器交错发送和传输这些帧的顺序是关键的性能决定因素  
HTTP/2 标准允许每个数据流都有一个关联的权重和依赖关系：
+ 可以向每个数据流分配一个介于1-256之间的整数
+ 每个数据流与其他数据流之间可以存在显式依赖关系

> 数据流依赖关系和权重的组合让客户端可以构建和传递“优先级树”，表明它倾向于如何接收响应。 反过来，服务器可以使用此信息通过控制 CPU、内存和其他资源的分配设定数据流处理的优先级，在资源数据可用之后，带宽分配可以确保将高优先级响应以最优方式传输至客户端。  
HTTP/2 内的数据流依赖关系通过将另一个数据流的唯一标识符作为父项引用进行声明；如果忽略标识符，相应数据流将依赖于“根数据流”。 声明数据流依赖关系指出，应尽可能先向父数据流分配资源，然后再向其依赖项分配资源。

## 每个来源一个连接
复用连接优点：  

+ 可以更有效地利用每个 TCP 连接，显著降低整体协议开销
+ 减少占用的内存和处理空间
+ 缩短完整连接路径（即，客户端、可信中介和源服务器之间的路径） 这降低了整体运行成本并提高了网络利用率和容量

## 流控制
>流控制是一种阻止*发送方*向*接收方*发送大量数据的机制，以免超出*接收方*的需求或处理能力：发送方可能非常繁忙、处于较高的负载之下，也可能仅仅希望为特定数据流分配固定量的资源。  

HTTP/2 提供了一组简单的构建块，这些构建块允许客户端和服务器实现其自己的数据流和连接级流控制：
+ **流控制具有方向性**。 每个接收方都可以根据自身需要为每个数据流和整个连接设置任意的窗口大小
+ **流控制基于信用**。 每个接收方都可以公布其初始连接和数据流流控制窗口（以字节为单位），每当发送方发出 DATA 帧时都会减小，在接收方发出 WINDOW_UPDATE 帧时增大
+ **流控制无法停用**。 建立 HTTP/2 连接后，客户端将与服务器交换 SETTINGS 帧，这会在两个方向上设置流控制窗口。 流控制窗口的默认值设为 65,535 字节，但是接收方可以设置一个较大的最大窗口大小（2^31-1 字节），并在接收到任意数据时通过发送 WINDOW_UPDATE 帧来维持这一大小。
+ **流控制为逐跃点控制，而非端到端控制**。 即，可信中介可以使用它来控制资源使用，以及基于自身条件和启发式算法实现资源分配机制

## 服务器推送
>HTTP/2 打破了严格的请求-响应语义，支持一对多和服务器发起的推送工作流.

### PUSH_PROMISE 101
所有服务器推送数据流都由 PUSH_PROMISE 帧发起，表明了服务器向客户端推送所述资源的意图，并且需要先于请求推送资源的响应数据传输。 在客户端接收到 PUSH_PROMISE 帧后，它可以根据自身情况选择拒绝数据流（通过 RST_STREAM 帧）。
